<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Amendment to Application — Web Filler (LF1042)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg:#f6f7f9;--card:#fff;--accent:#007aff;--muted:#666;
  }
  *{box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;margin:18px;background:var(--bg);color:#111}
  main{max-width:980px;margin:0 auto;background:var(--card);padding:18px;border-radius:10px;box-shadow:0 8px 28px rgba(0,0,0,0.06)}
  h1{margin-top:0;font-size:1.25rem}
  .section{background:#fbfbfd;border:1px solid #eee;padding:12px;border-radius:8px;margin:12px 0}
  .section h2{margin:0 0 8px 0}
  label{display:block;margin:8px 0;font-size:0.95rem}
  input[type=text],select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-top:6px}
  textarea{resize:none;overflow:hidden}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0}
  button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}
  button.secondary{background:#999}
  .actions{display:flex;gap:12px;align-items:center}
  .sig-preview{width:100%;height:60px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#aaa;font-size:0.9rem}
  .sig-preview img{max-width:100%;max-height:100%;object-fit:contain}
  /* Modal */
  .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:9999}
  .modal-content{background:#fff;width:95%;max-width:700px;border-radius:8px;padding:10px;display:flex;flex-direction:column;align-items:center}
  .modal canvas{width:100%;height:320px;border:1px solid #ccc;border-radius:8px;background:#fff;touch-action:none}
  .modal-buttons{margin-top:10px;display:flex;gap:10px}
  @media (min-width:720px){
    .modal canvas{height:360px}
  }
</style>
</head>
<body>
<main>
<h1>Amendment to Application — Web Filler</h1>

<!-- Section 1 -->
<section class="section">
<h2>Section 1 — Life Proposed Info</h2>
<label>Name
  <input id="LifeProposed_Name" type="text" placeholder="FULL NAME" oninput="this.value=this.value.toUpperCase()">
</label>
<label>NRIC
  <input id="LifeProposed_NRIC" type="text" placeholder="e.g. 900101-01-1234">
</label>
<label>Policy No.
  <input id="PolicyNo" type="text">
</label>
</section>

<!-- Section 2 -->
<section class="section">
<h2>Section 2 — Details of Amendment</h2>
<textarea id="Amendment_WriteDetails" placeholder="Describe the amendment in detail..." rows="5" oninput="autoResize(this)"></textarea>
</section>

<!-- Section 3 -->
<section class="section">
<h2>Section 3 — Signature & Policy Owner Info</h2>

<label>Signed State</label>
<select id="Signed_State">
  <option value="">Select State</option>
  <option>SELANGOR</option>
  <option>K.LUMPUR</option>
  <option>MELAKA</option>
  <option>JOHOR</option>
  <option>KEDAH</option>
  <option>KELANTAN</option>
  <option>NEGERI SEMBILAN</option>
  <option>PAHANG</option>
  <option>PENANG</option>
  <option>PERAK</option>
  <option>PERLIS</option>
  <option>SABAH</option>
  <option>SARAWAK</option>
  <option>TERENGGANU</option>
  <option>LABUAN</option>
  <option>PUTRAJAYA</option>
</select>

<div class="row">
  <label>Day
    <select id="Signed_Day"><option value="">Day</option></select>
  </label>
  <label>Month
    <select id="Signed_Month"><option value="">Month</option></select>
  </label>
  <label>Year
    <select id="Signed_Year"><option value="">Year</option></select>
  </label>
</div>

<h3>Policy Owner Info</h3>
<label>
  <input type="checkbox" id="sameAsLifeProposed" checked> Same as Life Proposed
</label>
<div class="row">
  <label>Policy Owner Name
    <input id="Sign_LifeProposedPO_Name" type="text">
  </label>
  <label>NRIC
    <input id="Sign_LifeProposedPO_NRIC" type="text">
  </label>
  <label>Mobile
    <input id="Sign_LifeProposedPO_Mobile" type="text">
  </label>
</div>

<h3>Policy Owner Signature</h3>
<div class="sig-preview" id="previewPO">Tap to sign</div>

<h3>Witness Info & Signature</h3>
<div class="row">
  <label>Name
    <input id="Sign_Witness_Name" type="text">
  </label>
  <label>NRIC
    <input id="Sign_Witness_NRIC" type="text">
  </label>
</div>
<div class="sig-preview" id="previewW">Tap to sign</div>

</section>

<!-- Actions -->
<section class="section actions">
  <button id="generate">Generate PDF</button>
  <button id="resetAll" class="secondary">Reset All</button>
</section>

<footer><small>Ensure <code>Amendment to Application_LF1042_fillable.pdf</code> is in the same folder as this HTML.</small></footer>
</main>

<!-- Modal -->
<div class="modal" id="sigModal" aria-hidden="true">
  <div class="modal-content">
    <canvas id="sigCanvas"></canvas>
    <div class="modal-buttons">
      <button id="doneSig">Done</button>
      <button id="clearSig" class="secondary">Clear</button>
      <button id="cancelSig" class="secondary">Cancel</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script>
// ----------------- small helpers -----------------
function autoResize(t){t.style.height="auto";t.style.height=t.scrollHeight+"px";}
function setHTML(elid, html){document.getElementById(elid).innerHTML = html;}
function getHTML(elid){ return document.getElementById(elid); }

// Populate day/month/year
(function(){
  const daySel=document.getElementById('Signed_Day');
  for(let i=1;i<=31;i++){daySel.innerHTML+=`<option>${i}</option>`;}
  const monthSel=document.getElementById('Signed_Month');
  const months=["JANUARY","FEBRUARY","MARCH","APRIL","MAY","JUNE","JULY","AUGUST","SEPTEMBER","OCTOBER","NOVEMBER","DECEMBER"];
  months.forEach(m=>monthSel.innerHTML+=`<option>${m}</option>`);
  const yearSel=document.getElementById('Signed_Year');
  const current=new Date().getFullYear();
  for(let y=current;y>=current-5;y--){yearSel.innerHTML+=`<option>${y}</option>`;}
})();

// Same as Life Proposed toggle
const sameCb=document.getElementById('sameAsLifeProposed');
const poName=document.getElementById('Sign_LifeProposedPO_Name');
const poNRIC=document.getElementById('Sign_LifeProposedPO_NRIC');
const lifeName=document.getElementById('LifeProposed_Name');
const lifeNRIC=document.getElementById('LifeProposed_NRIC');
sameCb.addEventListener('change',()=>{
  if(sameCb.checked){
    poName.value=lifeName.value;
    poNRIC.value=lifeNRIC.value;
    poName.readOnly=true;poNRIC.readOnly=true;
  } else {poName.readOnly=false;poNRIC.readOnly=false;}
});
lifeName.addEventListener('input',()=>{if(sameCb.checked)poName.value=lifeName.value;});
lifeNRIC.addEventListener('input',()=>{if(sameCb.checked)poNRIC.value=lifeNRIC.value;});

// ----------------- signature modal & canvas -----------------
const modal = document.getElementById('sigModal');
const canvas = document.getElementById('sigCanvas');
const ctx = canvas.getContext('2d');
let activePreviewId = null;
let drawing = false;

// Modal canvas desired CSS height (px) and comfort factor behavior
const modalCssHeight = 320; // visible height inside modal in CSS pixels

function resizeSigCanvas(){
  const dpr = window.devicePixelRatio || 1;
  const cssWidth = canvas.clientWidth; // CSS pixels width
  const cssHeight = modalCssHeight;    // CSS pixels height
  // Set actual pixel size
  canvas.width = Math.round(cssWidth * dpr);
  canvas.height = Math.round(cssHeight * dpr);
  // Make sure DOM size remains CSS size
  canvas.style.width = cssWidth + 'px';
  canvas.style.height = cssHeight + 'px';
  // Reset transform so coordinates are in CSS pixels
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  ctx.lineWidth = 2.5; // CSS px thickness (adjust if you want thicker pen)
  ctx.lineCap = 'round';
  ctx.strokeStyle = '#000';
}

// Convert event to local (CSS pixels) coordinates
function pos(e){
  const r = canvas.getBoundingClientRect();
  const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
  const clientY = (e.touches ? e.touches[0].clientY : e.clientY);
  return { x: clientX - r.left, y: clientY - r.top };
}

// Start / move / end handlers
function pointerDown(e){ drawing = true; ctx.beginPath(); const p = pos(e); ctx.moveTo(p.x, p.y); }
function pointerMove(e){ if(!drawing) return; const p = pos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); }
function pointerUp(e){ drawing = false; }

// Attach pointer listeners (works for mouse + touch)
canvas.addEventListener('mousedown', pointerDown);
canvas.addEventListener('mousemove', pointerMove);
canvas.addEventListener('mouseup', pointerUp);
canvas.addEventListener('mouseleave', pointerUp);
canvas.addEventListener('touchstart', (e)=>{ e.preventDefault(); pointerDown(e); }, {passive:false});
canvas.addEventListener('touchmove', (e)=>{ e.preventDefault(); pointerMove(e); }, {passive:false});
canvas.addEventListener('touchend', (e)=>{ e.preventDefault(); pointerUp(e); }, {passive:false});

// Open modal and load saved image if any
function openSig(previewId){
  activePreviewId = previewId;
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden', 'false');
  // resize AFTER visible so clientWidth is correct
  resizeSigCanvas();
  // clear canvas content in CSS coordinate space
  const dpr = window.devicePixelRatio || 1;
  ctx.clearRect(0,0, canvas.width / dpr, canvas.height / dpr);
  // load saved image (if any)
  const saved = localStorage.getItem(previewId + '_sig');
  if(saved){
    const img = new Image();
    img.onload = function(){
      // draw using CSS pixels (ctx is transformed to map CSS->device)
      ctx.drawImage(img, 0, 0, canvas.width / dpr, canvas.height / dpr);
    };
    img.src = saved;
  }
}

// Done: save and preview
function doneSig(){
  const dataUrl = canvas.toDataURL('image/png');
  if(!activePreviewId) return;
  localStorage.setItem(activePreviewId + '_sig', dataUrl);
  // show preview image
  const preview = document.getElementById(activePreviewId);
  preview.innerHTML = `<img src="${dataUrl}" alt="signature">`;
  closeModal();
}

// Clear canvas
function clearSig(){
  const dpr = window.devicePixelRatio || 1;
  ctx.clearRect(0,0, canvas.width / dpr, canvas.height / dpr);
}

// Cancel
function closeModal(){
  modal.style.display = 'none';
  modal.setAttribute('aria-hidden', 'true');
  activePreviewId = null;
}

// open preview click handlers
document.getElementById('previewPO').addEventListener('click', ()=> openSig('previewPO'));
document.getElementById('previewW').addEventListener('click', ()=> openSig('previewW'));

// modal buttons
document.getElementById('doneSig').addEventListener('click', doneSig);
document.getElementById('clearSig').addEventListener('click', clearSig);
document.getElementById('cancelSig').addEventListener('click', closeModal);

// when window resizes while modal open, resize canvas and redraw saved image (if any)
window.addEventListener('resize', ()=>{
  if(modal.style.display === 'flex' && activePreviewId){
    const saved = localStorage.getItem(activePreviewId + '_sig');
    resizeSigCanvas();
    const dpr = window.devicePixelRatio || 1;
    ctx.clearRect(0,0, canvas.width / dpr, canvas.height / dpr);
    if(saved){
      const img = new Image();
      img.onload = ()=> ctx.drawImage(img,0,0, canvas.width / dpr, canvas.height / dpr);
      img.src = saved;
    }
  }
});

// Load previews from storage on startup
['previewPO','previewW'].forEach(id=>{
  const saved = localStorage.getItem(id + '_sig');
  if(saved) document.getElementById(id).innerHTML = `<img src="${saved}" alt="signature">`;
});

// ----------------- LocalStorage for text fields -----------------
document.querySelectorAll('input,select,textarea').forEach(el=>{
  el.addEventListener('input', ()=> localStorage.setItem(el.id, el.value));
  const saved = localStorage.getItem(el.id);
  if(saved) el.value = saved;
});
document.querySelectorAll('textarea').forEach(t => autoResize(t));

// ----------------- PDF generation -----------------
async function fillPDF(){
  const res = await fetch('Amendment to Application_LF1042_fillable.pdf');
  const bytes = await res.arrayBuffer();
  const pdfDoc = await PDFLib.PDFDocument.load(bytes);
  const form = pdfDoc.getForm();

  function setField(id){
    const el = document.getElementById(id);
    if(!el) return;
    try{ form.getTextField(id).setText(el.value || ''); } catch(e){ console.warn('PDF field missing', id); }
  }

  ['PolicyNo','Amendment_WriteDetails','Signed_Day','Signed_Month','Signed_Year',
   'Sign_Witness_Name','Sign_Witness_NRIC','Sign_LifeProposedPO_Name',
   'Sign_LifeProposedPO_NRIC','Sign_LifeProposedPO_Mobile',
   'LifeProposed_NRIC','LifeProposed_Name','Signed_State'].forEach(setField);

  const pages = pdfDoc.getPages();
  const page = pages[0];

  async function addSignatureFromKey(key, x, y, w, h){
    const saved = localStorage.getItem(key + '_sig');
    if(!saved) return;
    const pngBytes = await fetch(saved).then(r=>r.arrayBuffer());
    const png = await pdfDoc.embedPng(pngBytes);
    // draw scaled into exact box
    page.drawImage(png, { x, y, width: w, height: h });
  }

  // exact coordinates from earlier measurement
  await addSignatureFromKey('previewPO', 317.4, 144.52, 242.04, 37.81);
  await addSignatureFromKey('previewW', 29.04, 145.83, 242.04, 36.51);

  const pdfBytes = await pdfDoc.save();
  const blob = new Blob([pdfBytes], { type: 'application/pdf' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'Filled_LF1042.pdf'; a.click();
  URL.revokeObjectURL(url);
}

document.getElementById('generate').addEventListener('click', fillPDF);
document.getElementById('resetAll').addEventListener('click', ()=>{
  if(confirm('Clear all saved form data?')){
    localStorage.clear();
    location.reload();
  }
});
</script>
</body>
</html>
