<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Amendment to Application — Web Filler</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg:#f6f7f9;--card:#fff;--accent:#007aff;--muted:#666;
  }
  *{box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;margin:18px;background:var(--bg);color:#111}
  main{max-width:980px;margin:0 auto;background:var(--card);padding:18px;border-radius:10px;box-shadow:0 8px 28px rgba(0,0,0,0.06)}
  h1{margin-top:0;font-size:1.25rem}
  .section{background:#fbfbfd;border:1px solid #eee;padding:12px;border-radius:8px;margin:12px 0}
  .section h2{margin:0 0 8px 0}
  label{display:block;margin:8px 0;font-size:0.95rem}
  input[type=text],select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-top:6px}
  textarea{resize:none;overflow:hidden}
  .row{display:flex;gap:12px;flex-wrap:wrap;margin:8px 0}
  button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}
  button.secondary{background:#999}
  .actions{display:flex;gap:12px;align-items:center}
  footer{margin-top:12px;color:var(--muted)}
  .sig-preview{
    border:1px solid #ccc;
    border-radius:8px;
    width:100%;
    height:60px;
    background:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    overflow:hidden;
  }
  .sig-preview img{max-width:100%;max-height:100%}
  /* Modal */
  #sigModal{
    display:none;
    position:fixed;
    z-index:9999;
    left:0;top:0;
    width:100%;height:100%;
    background:rgba(0,0,0,0.6);
    align-items:center;
    justify-content:center;
  }
  #sigModalContent{
    background:#fff;
    padding:12px;
    border-radius:8px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
  }
  #sigCanvas{
    border:1px solid #ccc;
    border-radius:8px;
    touch-action:none;
  }
</style>
</head>
<body>
<main>
<h1>Amendment to Application — Web Filler</h1>

<!-- Section 1 -->
<section class="section">
<h2>Section 1 — Life Proposed Info</h2>
<label>Name
  <input id="LifeProposed_Name" type="text" placeholder="FULL NAME">
</label>
<label>NRIC
  <input id="LifeProposed_NRIC" type="text" placeholder="e.g. 900101-01-1234">
</label>
<label>Policy No.
  <input id="PolicyNo" type="text">
</label>
</section>

<!-- Section 2 -->
<section class="section">
<h2>Section 2 — Details of Amendment</h2>
<textarea id="Amendment_WriteDetails" placeholder="Describe the amendment in detail..." rows="5"></textarea>
</section>

<!-- Section 3 -->
<section class="section">
<h2>Section 3 — Signature & Policy Owner Info</h2>
<label>Signed State</label>
<select id="Signed_State">
  <option value="">Select State</option>
  <option>SELANGOR</option><option>K.LUMPUR</option><option>MELAKA</option>
  <option>JOHOR</option><option>KEDAH</option><option>KELANTAN</option>
  <option>N.SEMBILAN</option><option>PAHANG</option><option>PENANG</option>
  <option>PERAK</option><option>PERLIS</option><option>SABAH</option>
  <option>SARAWAK</option><option>T'GANU</option><option>LABUAN</option>
  <option>PUTRAJAYA</option>
</select>

<div class="row">
  <label>Day
    <select id="Signed_Day"><option value="">Day</option></select>
  </label>
  <label>Month
    <select id="Signed_Month"><option value="">Month</option></select>
  </label>
  <label>Year
    <select id="Signed_Year"><option value="">Year</option></select>
  </label>
</div>

<h3>Witness Info</h3>
<div class="row">
  <label>Name
    <input id="Sign_Witness_Name" type="text">
  </label>
  <label>NRIC
    <input id="Sign_Witness_NRIC" type="text">
  </label>
</div>
<div class="sig-preview" onclick="openSig('witness')">
  <span>Tap to Sign (Witness)</span>
</div>

<label style="margin-top:12px; display:block;">
  <input type="checkbox" id="SameAsLifeProposed" /> Life Proposed is Policy Owner
</label>  
  
<h3>Policy Owner Info</h3>
<div class="row">
  <label>Policy Owner Name
    <input id="Sign_LifeProposedPO_Name" type="text">
  </label>
  <label>NRIC
    <input id="Sign_LifeProposedPO_NRIC" type="text">
  </label>
  <label>Mobile
    <input id="Sign_LifeProposedPO_Mobile" type="text">
  </label>
</div>
<div class="sig-preview" onclick="openSig('policyowner')">
  <span>Tap to Sign (Policy Owner)</span>
</div>
</section>

<!-- Actions -->
<section class="section actions">
  <button id="generate">Generate PDF</button>
  <button id="resetAll" class="secondary">Reset All</button>
</section>

<footer><small>Ensure <code>Amendment to Application_LF1042_fillable.pdf</code> is in the same folder as this HTML.</small></footer>
</main>

<!-- Signature Modal -->
<div id="sigModal">
  <div id="sigModalContent">
    <canvas id="sigCanvas"></canvas>
    <div>
      <button onclick="saveSig()">Done</button>
      <button onclick="clearSig()" class="secondary">Clear</button>
      <button onclick="closeSig()" class="secondary">Cancel</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script>
const sigRatio = 6.63; // shared ratio for both
const previews = {
  policyowner: document.querySelectorAll('.sig-preview')[1],
  witness: document.querySelectorAll('.sig-preview')[0]
};
let activeSigField = null;
const modal = document.getElementById('sigModal');
const canvas = document.getElementById('sigCanvas');
const ctx = canvas.getContext('2d');
let drawing = false;

function resizeCanvas(){
  const dpr = window.devicePixelRatio || 1;
  const cssWidth = Math.min(window.innerWidth * 0.95, 900);
  const cssHeight = cssWidth / sigRatio;
  canvas.width = cssWidth * dpr;
  canvas.height = cssHeight * dpr;
  canvas.style.width = cssWidth + 'px';
  canvas.style.height = cssHeight + 'px';
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  ctx.lineWidth = 2.5;
  ctx.lineCap = 'round';
  ctx.strokeStyle = '#000';
}

function openSig(field){
  activeSigField = field;
  modal.style.display = 'flex';
  resizeCanvas();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const saved = localStorage.getItem(field+'_sig');
  if(saved){
    const img = new Image();
    img.src = saved;
    img.onload = ()=>ctx.drawImage(img,0,0,canvas.width/(window.devicePixelRatio||1),canvas.height/(window.devicePixelRatio||1));
  }
}
function closeSig(){ modal.style.display = 'none'; }
function saveSig(){
  const dataURL = canvas.toDataURL();
  localStorage.setItem(activeSigField+'_sig', dataURL);
  previews[activeSigField].innerHTML = `<img src="${dataURL}">`;
  closeSig();
}
function clearSig(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  localStorage.removeItem(activeSigField+'_sig');
  previews[activeSigField].innerHTML = `<span>Tap to Sign (${activeSigField==='witness'?'Witness':'Policy Owner'})</span>`;
}

// Drawing events
canvas.addEventListener('mousedown', e=>{drawing=true;ctx.beginPath();ctx.moveTo(e.offsetX,e.offsetY);});
canvas.addEventListener('mousemove', e=>{if(!drawing)return;ctx.lineTo(e.offsetX,e.offsetY);ctx.stroke();});
canvas.addEventListener('mouseup', ()=>drawing=false);
canvas.addEventListener('mouseleave', ()=>drawing=false);
canvas.addEventListener('touchstart', e=>{
  e.preventDefault();
  const t=e.touches[0],rect=canvas.getBoundingClientRect();
  ctx.beginPath();
  ctx.moveTo(t.clientX-rect.left,t.clientY-rect.top);
  drawing=true;
},{passive:false});
canvas.addEventListener('touchmove', e=>{
  e.preventDefault();
  if(!drawing)return;
  const t=e.touches[0],rect=canvas.getBoundingClientRect();
  ctx.lineTo(t.clientX-rect.left,t.clientY-rect.top);
  ctx.stroke();
},{passive:false});
canvas.addEventListener('touchend', ()=>drawing=false);

// Populate Day/Month/Year
(function(){
  const daySel=document.getElementById('Signed_Day');
  for(let i=1;i<=31;i++){daySel.innerHTML+=`<option>${i}</option>`;}
  const monthSel=document.getElementById('Signed_Month');
  const months=["JANUARY","FEBRUARY","MARCH","APRIL","MAY","JUNE","JULY","AUGUST","SEPTEMBER","OCTOBER","NOVEMBER","DECEMBER"];
  months.forEach(m=>monthSel.innerHTML+=`<option>${m}</option>`);
  const yearSel=document.getElementById('Signed_Year');
  const current=new Date().getFullYear();
  for(let y=current;y>=current-5;y--){yearSel.innerHTML+=`<option>${y}</option>`;}
})();

// LocalStorage for text inputs
document.querySelectorAll("input,select,textarea").forEach(el=>{
  el.addEventListener("input",()=>localStorage.setItem(el.id,el.value));
  const saved=localStorage.getItem(el.id);if(saved)el.value=saved;
});

// Fill PDF
async function fillPDF(){
  const res=await fetch("Amendment to Application_LF1042_fillable.pdf");
  const bytes=await res.arrayBuffer();
  const pdfDoc=await PDFLib.PDFDocument.load(bytes);
  const form=pdfDoc.getForm();
  function set(id){try{form.getTextField(id).setText(document.getElementById(id).value||"");}catch(e){}}
  set("LifeProposed_Name");set("LifeProposed_NRIC");set("PolicyNo");
  set("Amendment_WriteDetails");
  set("Signed_Day");set("Signed_Month");set("Signed_Year");
  set("Signed_State");set("Sign_Witness_Name");set("Sign_Witness_NRIC");
  set("Sign_LifeProposedPO_Name");set("Sign_LifeProposedPO_NRIC");set("Sign_LifeProposedPO_Mobile");

  const pages=pdfDoc.getPages();
  const page=pages[0];
  const sigWidth=242.04, sigHeight=36.51;
  const poSig=localStorage.getItem('policyowner_sig');
  const wSig=localStorage.getItem('witness_sig');
  if(poSig){
    const png=await pdfDoc.embedPng(await fetch(poSig).then(r=>r.arrayBuffer()));
    page.drawImage(png,{x:350,y:150,width:sigWidth,height:sigHeight});
  }
  if(wSig){
    const png=await pdfDoc.embedPng(await fetch(wSig).then(r=>r.arrayBuffer()));
    page.drawImage(png,{x:150,y:150,width:sigWidth,height:sigHeight});
  }
  const pdfBytes=await pdfDoc.save();
  const blob=new Blob([pdfBytes],{type:"application/pdf"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;a.download="Filled_LF1042.pdf";a.click();
  URL.revokeObjectURL(url);
}
document.getElementById("generate").addEventListener("click",fillPDF);
document.getElementById("resetAll").addEventListener("click",()=>{
  localStorage.clear();location.reload();
});

const checkbox = document.getElementById('SameAsLifeProposed');

function copyLifeProposedToPolicyOwner(){
  if(checkbox.checked){
    document.getElementById('Sign_LifeProposedPO_Name').value = document.getElementById('LifeProposed_Name').value;
    document.getElementById('Sign_LifeProposedPO_NRIC').value = document.getElementById('LifeProposed_NRIC').value;
  } else {
    document.getElementById('Sign_LifeProposedPO_Name').value = '';
    document.getElementById('Sign_LifeProposedPO_NRIC').value = '';
  }
}

checkbox.addEventListener('change', copyLifeProposedToPolicyOwner);

document.getElementById('LifeProposed_Name').addEventListener('input', () => {
  if(checkbox.checked){
    document.getElementById('Sign_LifeProposedPO_Name').value = document.getElementById('LifeProposed_Name').value;
  }
});
document.getElementById('LifeProposed_NRIC').addEventListener('input', () => {
  if(checkbox.checked){
    document.getElementById('Sign_LifeProposedPO_NRIC').value = document.getElementById('LifeProposed_NRIC').value;
  }
});
</script>
</body>
</html>
