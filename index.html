<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Amendment to Application — Web Filler (LF1042)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<!-- pdf-lib for filling & flattening -->
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<!-- pdfjs-dist for quick preview of the generated PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.worker.min.js"></script>
<style>
  :root{
    --bg:#f6f7f9; --card:#fff; --accent:#007aff; --muted:#666; --line:#e9e9ee;
  }
  *{box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;margin:18px;background:var(--bg);color:#111}
  main{max-width:980px;margin:0 auto;background:var(--card);padding:18px;border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,0.06)}
  h1{margin:15px 0 35px 0;font-size:1.50rem}
  .section{background:#fbfbfd;border:1px solid #eee;padding:14px;border-radius:10px;margin:12px 0}
  .section h2{margin:0 0 10px 0;font-size:1.05rem}
  label{display:block;margin:8px 0;font-size:0.95rem}
  input[type=text],input[type=number],input[type=tel],select,textarea{
    width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;margin-top:6px;font-size:1rem;background:#fff
  }
  textarea{resize:vertical;min-height:120px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0}
  .muted{color:var(--muted);font-size:0.85rem}
  button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer}
  button.secondary{background:#999}
  button.ghost{background:transparent;border:1px solid var(--line);color:#333}
  .actions{display:flex;gap:12px;align-items:center}

  /* Policy grid (replicated multi-item behavior) */
  .policy-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .policy{background:#fff;padding:12px;border-radius:10px;border:1px solid #eee;position:relative}
  .policy h3{margin:0 0 8px 0;font-size:0.95rem;display:flex;align-items:center;justify-content:space-between}
  .policy .remove-btn{background:transparent;border:1px solid var(--line);color:#333;border-radius:8px;padding:6px 10px;font-size:0.9rem}
  .policy .remove-btn:hover{border-color:#d0d0d7}

  /* Signature preview tiles */
  .sig-preview{
    width:100%; height:150px; border:1px dashed #bbb; border-radius:10px;
    display:flex; align-items:center; justify-content:center; background:#fff; cursor:pointer; position:relative;
  }
  .sig-preview img{ max-width:100%; max-height:100%; object-fit:contain; }
  .sig-preview span{ color:#999; }

  /* Signature Modal */
  .sig-modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1000; }
  .sig-modal .box{
    width:min(560px, 92vw); background:#fff; margin:6vh auto; padding:14px; border-radius:12px;
    box-shadow:0 18px 50px rgba(0,0,0,.25)
  }
  .sig-modal h3{ margin:0 0 8px 0; }
  /* NOTE: canvas is responsive via CSS; internal pixels are set in JS for crispness */
  #sigCanvas{ width:100%; height:220px; background:#fff; border:1px solid #ddd; border-radius:10px; touch-action:none }
  .sig-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:10px; }

  /* XY% signature tuning panel (like reference) */
  .hidden-inputs {display: none;}
  .xy-tuning{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .xy-tuning input[type=number]{width:100%}

  /* Save indicator */
  #saveStatus{
    position:fixed; bottom:12px; right:12px; background:var(--accent); color:#fff;
    padding:6px 10px; border-radius:8px; font-size:0.85rem; opacity:0; transition:opacity .25s;
  }

  /* Preview panel */
  .preview-wrap{background:#fff;border:1px solid #eee;border-radius:10px;padding:10px}
  #pdfPreview{width:100%; max-width:100%; border:0}
  #pdfCanvas{width:100%; height:auto; display:block}

  @media (max-width:720px){
    .policy-grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<main>
  <h1>Amendment to Application (LF1042)</h1>

  <!-- Section: Proposed Life Insured Info -->
  <section class="section">
    <h2>Proposed Life Insured Info</h2>
    <div class="row">
      <label style="flex:1">Proposed Life Insured/Insured Name
        <input id="LifeProposed_Name" type="text" placeholder="FULL NAME AS IN I/C">
      </label>
      <label style="flex:1">IC No.
        <input id="LifeProposed_NRIC" type="text" placeholder="e.g. 900101-14-1234">
      </label>
      <label style="flex:1">Policy No. 
        <input id="PolicyNo" type="text" placeholder="Enter Policy No.">
    </div>
  </section>


  <!-- Section: Details of Amendment -->
  <section class="section">
    <h2>Details of Amendment</h2>
    <label>Write details here
      <textarea id="Amendment_WriteDetails" rows="5" placeholder="Describe the requested amendment in detail..."></textarea>
    </label>
  </section>

  <!-- Section: Signature + Date -->
  <section class="section">
    <h2>Signing Details</h2>
    <div class="row">
      <label style="flex:1">Signed at (State)
        <select id="Signed_State">
          <option value="">-- Select State --</option>
        </select>
      </label>
      <label style="flex:1">Day
        <select id="Signed_Day">
          <option value="">-- Day --</option>
        </select>
      </label>
      <label style="flex:1">Month
        <select id="Signed_Month">
          <option value="">-- Month --</option>
        </select>
      </label>
      <label style="flex:1">Year
        <select id="Signed_Year">
          <option value="">-- Year (YYYY) --</option>
        </select>
      </label>
    </div>
  </section>

  <!-- Section: Signatures -->
  <section class="section" id="sectionE">
    <h2>Section — Signatures</h2>

    <!-- Proposed Life Insured / Policyowner -->
    <div class="section" style="margin:0 0 12px 0">
      <h3 style="margin:0 0 8px 0">Signature of Proposed Life Insured/Policyowner</h3>
      <div class="row">
        <label style="flex:1">Name of Proposed Life Insured/Policyowner
          <input id="Sign_LifeProposedPO_Name" type="text" placeholder="AS IN I/C">
        </label>
      </div>
      <div class="row">
        <div id="ownerSigPreview" class="sig-preview" data-target="owner"><span>Tap to Sign (Owner)</span></div>
        <button class="ghost" id="ownerClear">Clear Signature</button>
      </div>

      <!-- XY% placement tuning for Owner (kept visible for power-users; same pattern as reference) -->
      <details class="muted">
        <summary>Owner Signature XY% & Scale Tuning</summary>
        <div class="xy-tuning">
          <label>X (%)
            <input id="OwnerSigX" type="number" min="0" max="100" step="0.1" value="63">
          </label>
          <label>Y (%)
            <input id="OwnerSigY" type="number" min="0" max="100" step="0.1" value="36">
          </label>
          <label>Scale (%)
            <input id="OwnerSigScale" type="number" min="10" max="300" step="1" value="55">
          </label>
        </div>
      </details>
    </div>

    <!-- Witness -->
    <div class="section" style="margin:0">
      <h3 style="margin:0 0 8px 0">Signature of Witness</h3>
      <div class="row">
        <label style="flex:1">Name of Witness
          <input id="Sign_Witness_Name" type="text" placeholder="FULL NAME">
        </label>
        <label style="flex:1">IC No.
          <input id="Sign_Witness_NRIC" type="text" placeholder="e.g. 800202-08-5678">
        </label>
      </div>
      <div class="row">
        <div id="witnessSigPreview" class="sig-preview" data-target="witness"><span>Tap to Sign (Witness)</span></div>
        <button class="ghost" id="witnessClear">Clear Signature</button>
      </div>

      <!-- XY% placement tuning for Witness -->
      <details class="muted">
        <summary>Witness Signature XY% & Scale Tuning</summary>
        <div class="xy-tuning">
          <label>X (%)
            <input id="WitnessSigX" type="number" min="0" max="100" step="0.1" value="19">
          </label>
          <label>Y (%)
            <input id="WitnessSigY" type="number" min="0" max="100" step="0.1" value="28">
          </label>
          <label>Scale (%)
            <input id="WitnessSigScale" type="number" min="10" max="300" step="1" value="55">
          </label>
        </div>
      </details>
    </div>
  </section>

  <!-- Actions -->
  <section class="section">
    <div class="actions">
      <button id="generatePdf">Generate PDF</button>
      <button class="secondary" id="resetAll">Reset All</button>
      <small class="muted">Ensure <code>Amendment to Application_LF1042_fillable.pdf</code> is in the same folder.</small>
    </div>
  </section>

  <!-- Preview -->
  <section class="section preview-wrap">
    <h2>PDF Preview</h2>
    <canvas id="pdfCanvas"></canvas>
  </section>

</main>

<!-- Signature Modal -->
<div id="sigModal" class="sig-modal" aria-hidden="true">
  <div class="box">
    <h3 id="sigModalTitle">Draw Signature</h3>
    <canvas id="sigCanvas"></canvas>
    <div class="sig-actions">
      <button id="sigDone">Done</button>
      <button class="secondary" id="sigClear">Clear</button>
      <button class="ghost" id="sigCancel">Cancel</button>
    </div>
  </div>
</div>

<div id="saveStatus">Saved</div>

<script>
/* ============================================================
   CONSTANTS & STORAGE KEYS
   ============================================================ */
const PDF_FILE = 'Amendment to Application_LF1042_fillable.pdf'; // File to fetch from same folder
const LS_KEY = 'lf1042_amendment_autosave_v1';
const MAX_POLICIES = 4;

/* Signature XY% positions & scale defaults (UI also exposes and autosaves them)
   These are percentages relative to the PDF page width/height.
   Scale is the signature image width as a percentage of page width.
   Tune visually with the exposed inputs. */
const DEFAULT_PLACEMENT = {
  owner:  { xPct: 63, yPct: 36, scalePct: 55 },
  witness:{ xPct: 19, yPct: 28, scalePct: 55 }
};

/* Malaysia states list & date options (mirrors reference style/labels) */
const STATES = [
  'Johor','Kedah','Kelantan','Melaka','Negeri Sembilan','Pahang','Penang',
  'Perak','Perlis','Sabah','Sarawak','Selangor','Terengganu',
  'Kuala Lumpur','Putrajaya','Labuan'
];
const MONTHS = [
  '01 - January','02 - February','03 - March','04 - April','05 - May','06 - June',
  '07 - July','08 - August','09 - September','10 - October','11 - November','12 - December'
];

/* ============================================================
   STATE
   ============================================================ */
let appState = {
  LifeProposed_Name: '',
  LifeProposed_NRIC: '',
  policies: [],               // [{id, PolicyNo}]
  Amendment_WriteDetails: '',
  Signed_State: '',
  Signed_Day: '',
  Signed_Month: '',
  Signed_Year: '',
  Sign_LifeProposedPO_Name: '',
  Sign_Witness_Name: '',
  Sign_Witness_NRIC: '',
  signatures: { owner: '', witness: '' }, // dataURL PNG
  placement: {
    owner: {...DEFAULT_PLACEMENT.owner},
    witness:{...DEFAULT_PLACEMENT.witness}
  }
};

/* ============================================================
   HELPERS
   ============================================================ */
const $ = sel => document.querySelector(sel);
const el = (tag, props={}) => Object.assign(document.createElement(tag), props);

function showSaved(){
  const n = $('#saveStatus');
  n.style.opacity = '1';
  setTimeout(()=> n.style.opacity = '0', 900);
}
function persist(){
  localStorage.setItem(LS_KEY, JSON.stringify(appState));
  showSaved();
}
function loadPersisted(){
  const raw = localStorage.getItem(LS_KEY);
  if(!raw) return;
  try{
    appState = Object.assign(appState, JSON.parse(raw));
  }catch(e){}
}

/* ============================================================
   INIT STATIC SELECTS (States / Day / Month / Year)
   ============================================================ */
function initDateSelectors(){
  const stateSel = $('#Signed_State');
  STATES.forEach(s => stateSel.append(el('option', {value:s, textContent:s})));

  const daySel = $('#Signed_Day');
  for(let d=1; d<=31; d++) daySel.append(el('option', {value:String(d).padStart(2,'0'), textContent:String(d).padStart(2,'0')}));

  const monthSel = $('#Signed_Month');
  MONTHS.forEach(m => monthSel.append(el('option', {value:m.slice(0,2), textContent:m})));

  const yearSel = $('#Signed_Year');
  const yr = new Date().getFullYear();
  for(let y=yr; y>=yr-35; y--) yearSel.append(el('option', {value:String(y), textContent:String(y)}));
}

/* ============================================================
   BIND BASIC FIELDS
   ============================================================ */
function bindBasicField(id){
  const node = document.getElementById(id);
  const assign = ()=>{
    appState[id] = node.value;
    persist();
  };
  node.addEventListener('input', assign);
  // restore
  if(appState[id]) node.value = appState[id];
}
function bindSelectField(id){
  const node = document.getElementById(id);
  const assign = ()=>{
    appState[id] = node.value;
    persist();
  };
  node.addEventListener('change', assign);
  if(appState[id]) node.value = appState[id];
}


/* ============================================================
   SIGNATURE MODAL + CANVAS (shared for owner/witness)
   ============================================================ */
let sigTarget = null; // 'owner' | 'witness'
let isDrawing = false;
let lastX=0, lastY=0;
let ctx, sigCanvas;

function openSigModal(target){
  sigTarget = target;
  $('#sigModalTitle').textContent = target==='owner' ? 'Draw Signature (Owner)' : 'Draw Signature (Witness)';
  $('#sigModal').style.display = 'block';
  setupSigCanvas();
}

function closeSigModal(){ $('#sigModal').style.display = 'none'; }

function setupSigCanvas(){
  sigCanvas = document.getElementById('sigCanvas');
  // set crisp internal pixels
  const cssW = sigCanvas.clientWidth;
  const cssH = sigCanvas.clientHeight;
  const dpr  = window.devicePixelRatio || 1;
  sigCanvas.width = Math.floor(cssW*dpr);
  sigCanvas.height= Math.floor(cssH*dpr);
  ctx = sigCanvas.getContext('2d');
  ctx.scale(dpr, dpr);
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  ctx.lineWidth = 2.5;
  ctx.strokeStyle = '#000';

  // load existing if any
  let dataUrl = appState.signatures[sigTarget];
  if(dataUrl){
    let img = new Image();
    img.onload = ()=> ctx.drawImage(img, 0, 0, cssW, cssH);
    img.src = dataUrl;
  }
}

function canvasPos(e){
  const rect = sigCanvas.getBoundingClientRect();
  const xp = (e.touches? e.touches[0].clientX : e.clientX) - rect.left;
  const yp = (e.touches? e.touches[0].clientY : e.clientY) - rect.top;
  return {x: xp, y: yp};
}

function startDraw(e){ isDrawing=true; const p=canvasPos(e); lastX=p.x; lastY=p.y; }
function moveDraw(e){
  if(!isDrawing) return;
  e.preventDefault();
  const p=canvasPos(e);
  ctx.beginPath();
  ctx.moveTo(lastX,lastY);
  ctx.lineTo(p.x,p.y);
  ctx.stroke();
  lastX=p.x; lastY=p.y;
}
function endDraw(){ isDrawing=false; }

function bindSigCanvasEvents(){
  sigCanvas.addEventListener('mousedown', startDraw);
  sigCanvas.addEventListener('mousemove', moveDraw);
  window.addEventListener('mouseup', endDraw);

  sigCanvas.addEventListener('touchstart', startDraw, {passive:false});
  sigCanvas.addEventListener('touchmove', moveDraw, {passive:false});
  sigCanvas.addEventListener('touchend', endDraw);
}

/* ============================================================
   PREVIEW (render first page of current generated PDF into <canvas>)
   ============================================================ */
async function renderPreview(arrayBuffer){
  try{
    const loadingTask = pdfjsLib.getDocument({data: arrayBuffer});
    const pdf = await loadingTask.promise;
    const page = await pdf.getPage(1);
    const viewport = page.getViewport({scale: 1.25});
    const canvas = document.getElementById('pdfCanvas');
    const ctx = canvas.getContext('2d');

    canvas.width = viewport.width;
    canvas.height = viewport.height;

    await page.render({canvasContext: ctx, viewport}).promise;
  }catch(err){
    console.warn('Preview error:', err);
  }
}

/* ============================================================
   PDF FILLING + FLATTENING (pdf-lib)
   Maps HTML IDs to PDF field names as specified:
   - LifeProposed_Name       -> LifeProposed_Name
   - LifeProposed_NRIC       -> LifeProposed_NRIC
   - PolicyNo                -> PolicyNo   (takes the FIRST policy listed)
   - Amendment_WriteDetails  -> Amendment_WriteDetails
   - Signed_State            -> Signed_State
   - Signed_Day              -> Signed_Day
   - Signed_Month            -> Signed_Month
   - Signed_Year             -> Signed_Year
   Signatures: embedded as PNG at XY% positions (configurable above & via inputs)
   ============================================================ */
async function generatePDF(){
  // Fetch base form
  const baseBytes = await fetch(PDF_FILE).then(r=>r.arrayBuffer());
  const pdfDoc = await PDFLib.PDFDocument.load(baseBytes);
  const form = pdfDoc.getForm();

  // Helper for safe set text
  function setText(fieldName, value){
    try{
      const fld = form.getTextField(fieldName);
      fld.setText(value || '');
    }catch(e){
      // ignore if field not found
      console.warn('Missing field:', fieldName);
    }
  }

  // Fill fields
  setText('LifeProposed_Name', appState.LifeProposed_Name);
  setText('LifeProposed_NRIC', appState.LifeProposed_NRIC);
  setText('PolicyNo', (appState.policies[0]?.PolicyNo) || '');
  setText('Amendment_WriteDetails', appState.Amendment_WriteDetails);
  setText('Signed_State', appState.Signed_State);
  setText('Signed_Day', appState.Signed_Day);
  setText('Signed_Month', appState.Signed_Month);
  setText('Signed_Year', appState.Signed_Year);
  setText('Sign_Witness_Name', appState.Sign_Witness_Name);

  // Flatten fields
  try{ form.flatten(); }catch(e){ console.warn('Flatten warning:', e); }

  // Embed signatures
  const pages = pdfDoc.getPages();
  const page = pages[0]; // Adjust if signatures are on another page.

  // Util: place signature by XY% of page + scale%
  async function placeSignature(target, dataUrl){
    if(!dataUrl) return;
    const png = await pdfDoc.embedPng(dataUrl);
    const { width: pw, height: ph } = page.getSize();

    const conf = appState.placement[target];
    // Convert % to absolute px
    const imgW = pw * (Number(conf.scalePct||DEFAULT_PLACEMENT[target].scalePct)/100);
    const aspect = png.height / png.width;
    const imgH = imgW * aspect;
    const x = pw * (Number(conf.xPct||DEFAULT_PLACEMENT[target].xPct)/100) - (imgW/2);
    const y = ph * (Number(conf.yPct||DEFAULT_PLACEMENT[target].yPct)/100) - (imgH/2);

    page.drawImage(png, { x, y, width: imgW, height: imgH });
  }

  await placeSignature('owner', appState.signatures.owner);
  await placeSignature('witness', appState.signatures.witness);

  const outBytes = await pdfDoc.save();
  await renderPreview(outBytes);

  // Offer download
  const blob = new Blob([outBytes], {type:'application/pdf'});
  const url = URL.createObjectURL(blob);
  const a = el('a', {href:url, download:'Amendment_to_Application_LF1042_filled.pdf'});
  document.body.append(a);
  a.click();
  a.remove();
  setTimeout(()=> URL.revokeObjectURL(url), 2500);
}

/* ============================================================
   WIRE-UP / RESTORE
   ============================================================ */
function restoreBasic(id){ const n=document.getElementById(id); if(n && appState[id]) n.value=appState[id]; }
function restoreSelect(id){ const n=document.getElementById(id); if(n && appState[id]) n.value=appState[id]; }
function restoreSigPreviews(){
  // owner
  const oPrev = $('#ownerSigPreview');
  oPrev.innerHTML = appState.signatures.owner ? `<img alt="Owner Signature" src="${appState.signatures.owner}">` : '<span>Tap to Sign (Owner)</span>';
  // witness
  const wPrev = $('#witnessSigPreview');
  wPrev.innerHTML = appState.signatures.witness ? `<img alt="Witness Signature" src="${appState.signatures.witness}">` : '<span>Tap to Sign (Witness)</span>';
}
function bindXYTuning(){
  const map = [
    ['OwnerSigX','owner','xPct'],
    ['OwnerSigY','owner','yPct'],
    ['OwnerSigScale','owner','scalePct'],
    ['WitnessSigX','witness','xPct'],
    ['WitnessSigY','witness','yPct'],
    ['WitnessSigScale','witness','scalePct'],
  ];
  map.forEach(([id, who, key])=>{
    const n = document.getElementById(id);
    n.value = appState.placement[who][key];
    n.addEventListener('input', ()=>{
      appState.placement[who][key] = Number(n.value);
      persist();
    });
  });
}

/* ============================================================
   RESET
   ============================================================ */
function resetAll(){
  localStorage.removeItem(LS_KEY);
  // Reset in-memory state
  appState = {
    LifeProposed_Name: '',
    LifeProposed_NRIC: '',
    policies: [],
    Amendment_WriteDetails: '',
    Signed_State: '',
    Signed_Day: '',
    Signed_Month: '',
    Signed_Year: '',
    Sign_LifeProposedPO_Name: '',
    Sign_Witness_Name: '',
    Sign_Witness_NRIC: '',
    signatures: { owner: '', witness: '' },
    placement: {
      owner: {...DEFAULT_PLACEMENT.owner},
      witness:{...DEFAULT_PLACEMENT.witness}
    }
  };
  // UI reset
  document.querySelectorAll('input[type=text], textarea').forEach(i=> i.value='');
  document.querySelectorAll('select').forEach(s=> s.value='');
  renderPolicies();
  restoreSigPreviews();
  bindXYTuning();
  showSaved();
}

/* ============================================================
   BOOT
   ============================================================ */
window.addEventListener('DOMContentLoaded', ()=>{
  // load persisted before building UI
  loadPersisted();

  initDateSelectors();

  // Bind base fields
  [
    'LifeProposed_Name',
    'LifeProposed_NRIC',
    'Amendment_WriteDetails',
    'Sign_LifeProposedPO_Name',
    'Sign_Witness_Name',
    'Sign_Witness_NRIC'
  ].forEach(bindBasicField);

  ['Signed_State','Signed_Day','Signed_Month','Signed_Year'].forEach(bindSelectField);

  // Policies
  $('#addPolicy').addEventListener('click', ()=>{
    addPolicy('');
  });
  // ensure counter > max id
  policyCounter = Math.max(0, ...appState.policies.map(p=>p.id), 0);
  renderPolicies();

  // Signature previews -> open modal
  $('#ownerSigPreview').addEventListener('click', ()=> openSigModal('owner'));
  $('#witnessSigPreview').addEventListener('click', ()=> openSigModal('witness'));

  // Clear signature buttons
  $('#ownerClear').addEventListener('click', ()=>{
    appState.signatures.owner = '';
    persist();
    restoreSigPreviews();
  });
  $('#witnessClear').addEventListener('click', ()=>{
    appState.signatures.witness = '';
    persist();
    restoreSigPreviews();
  });

  // Modal controls
  $('#sigDone').addEventListener('click', ()=>{
    // save canvas to dataURL
    const cssW = sigCanvas.clientWidth, cssH = sigCanvas.clientHeight;
    // create a temporary same-size canvas to export crisp PNG at CSS size
    const tmp = document.createElement('canvas');
    tmp.width = cssW; tmp.height = cssH;
    const tctx = tmp.getContext('2d');
    // draw from current canvas (which may have higher DPR)
    tctx.drawImage(sigCanvas, 0, 0, cssW, cssH);
    const dataUrl = tmp.toDataURL('image/png');
    appState.signatures[sigTarget] = dataUrl;
    persist();
    restoreSigPreviews();
    closeSigModal();
  });
  $('#sigClear').addEventListener('click', ()=>{
    ctx.clearRect(0,0,sigCanvas.width,sigCanvas.height);
  });
  $('#sigCancel').addEventListener('click', closeSigModal);

  // Prepare modal canvas after open
  document.getElementById('sigModal').addEventListener('transitionend', bindSigCanvasEvents);

  // Modal open sets up canvas & events
  // (We also ensure events bound once on first open:)
  let canvasBound = false;
  const ensureCanvasEvents = ()=>{
    if(canvasBound) return;
    bindSigCanvasEvents();
    canvasBound = true;
  };
  // Hook after canvas creation:
  const origOpen = openSigModal;
  openSigModal = function(target){ origOpen(target); ensureCanvasEvents(); };

  // XY tuning fields
  bindXYTuning();

  // Restore previously saved inputs into DOM
  restoreBasic('LifeProposed_Name');
  restoreBasic('LifeProposed_NRIC');
  restoreBasic('Amendment_WriteDetails');
  restoreBasic('Sign_LifeProposedPO_Name');
  restoreBasic('Sign_Witness_Name');
  restoreBasic('Sign_Witness_NRIC');

  restoreSelect('Signed_State');
  restoreSelect('Signed_Day');
  restoreSelect('Signed_Month');
  restoreSelect('Signed_Year');

  restoreSigPreviews();

  // Actions
  $('#generatePdf').addEventListener('click', ()=> generatePDF().catch(console.error));
  $('#resetAll').addEventListener('click', resetAll);
});
</script>
</body>
</html>
